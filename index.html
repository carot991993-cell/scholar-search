<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>C√¥ng c·ª• T√¨m ki·∫øm & Tr√≠ch xu·∫•t H·ªçc thu·∫≠t C√° nh√¢n</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

</head>
<body class="bg-gray-50 text-gray-900">

<!-- HEADER -->
<header class="text-center py-10">
  <h1 class="text-3xl font-bold text-indigo-600">
    C√¥ng c·ª• T√¨m ki·∫øm & Tr√≠ch xu·∫•t H·ªçc thu·∫≠t C√° nh√¢n
  </h1>
  <p class="mt-2 text-gray-500">
    Giao di·ªán ki·ªÉu Google Scholar Labs
  </p>
</header>

<!-- MAIN -->
<main class="max-w-7xl mx-auto px-6">

  <div class="grid grid-cols-12 gap-6">

    <!-- FILTER -->
    <aside class="col-span-3 space-y-6">

      <div class="bg-white p-4 rounded-lg shadow">
        <h3 class="font-semibold mb-3">Th·ªùi gian</h3>

        <label class="flex items-center gap-2 text-sm mb-2">
          <input type="radio" name="year" value="" checked>
          B·∫•t k·ª≥
        </label>

        <label class="flex items-center gap-2 text-sm mb-2">
          <input type="radio" name="year" value="5">
          5 nƒÉm
        </label>

        <label class="flex items-center gap-2 text-sm">
          <input type="radio" name="year" value="10">
          10 nƒÉm
        </label>

        <hr class="my-4">

        <h3 class="font-semibold mb-3">B·ªô l·ªçc K·∫øt qu·∫£</h3>

        <label class="flex items-center gap-2 text-sm mb-2">
          <input type="checkbox" id="hasAbstract"> C√≥ t√≥m t·∫Øt
        </label>

        <label class="flex items-center gap-2 text-sm mb-2">
          <input type="checkbox" id="freeFullText"> To√†n vƒÉn mi·ªÖn ph√≠
        </label>

        <label class="flex items-center gap-2 text-sm mb-2">
          <input type="checkbox" id="medline"> MEDLINE
        </label>

        <label class="flex items-center gap-2 text-sm">
          <input type="checkbox" id="excludePreprint"> Lo·∫°i tr·ª´ Preprints
        </label>
      </div>
<div class="bg-white p-4 rounded-lg shadow">
  <h3 class="font-semibold mb-3">L·ªãch s·ª≠ t√¨m ki·∫øm</h3>
  <ul id="searchHistory" class="space-y-2 text-sm text-indigo-600"></ul>
</div>
    </aside>

    <!-- SEARCH + RESULT -->
    <section class="col-span-9 space-y-6">

      <div class="flex gap-4">
        <input id="query" type="text"
               class="flex-1 border rounded px-4 py-3"
               placeholder="Nh·∫≠p t·ª´ kh√≥a h·ªçc thu·∫≠t">

        <button onclick="searchScholar()"
                class="bg-indigo-600 text-white px-6 py-3 rounded hover:bg-indigo-700">
          T√¨m ki·∫øm
        </button>

        <select class="border rounded px-3 py-3 text-sm">
          <option>Li√™n quan</option>
          <option>M·ªõi nh·∫•t</option>
        </select>
      </div>

      <div id="loading" class="hidden text-gray-500">
        ƒêang t√¨m ki·∫øm...
      </div>
      <div class="flex gap-3 mb-4">
  <button onclick="exportBibTeX()"
          class="bg-green-600 text-white px-4 py-2 rounded text-sm">
    Xu·∫•t BibTeX
  </button>

  <button onclick="exportCSV()"
          class="bg-blue-600 text-white px-4 py-2 rounded text-sm">
    Xu·∫•t CSV
  </button>
</div>
      <div id="results" class="space-y-4"></div>

    </section>

  </div>

</main>

<!-- SCRIPT -->
<script>
const API_URL = "https://scholar-proxy.tm-b30.workers.dev/";
let LAST_RESULTS = [];

function showLoading() {
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("results").innerHTML = "";
}

function hideLoading() {
  document.getElementById("loading").classList.add("hidden");
}
function highlight(text, keyword) {
  if (!keyword) return text;
  return text.replace(
    new RegExp("(" + keyword + ")", "gi"),
    "<mark class='bg-yellow-200'>$1</mark>"
  );
}
function renderResults(items) {
  const container = document.getElementById("results");
  container.innerHTML = "";

  if (!items || items.length === 0) {
    container.innerHTML =
      "<p class='text-gray-500'>Kh√¥ng c√≥ k·∫øt qu·∫£ ph√π h·ª£p.</p>";
    return;
  }

  items.forEach((item, index) => {
    const keyword = document.getElementById("query").value.trim();
    const title = highlight(item.title || "Kh√¥ng ti√™u ƒë·ªÅ", keyword);
    const link = item.link || "#";
    const snippet = highlight(item.snippet || "", keyword);

    const publication =
      item.publication_info?.summary || "";

    const authors =
      item.publication_info?.authors
        ? item.publication_info.authors.map(a => a.name).join(", ")
        : "";

    const cited =
      item.inline_links?.cited_by?.total
        ? `‚≠ê Tr√≠ch d·∫´n: ${item.inline_links.cited_by.total}`
        : "";

    const pdf =
      item.resources && item.resources.length > 0
        ? item.resources.find(r => r.file_format === "PDF")
        : null;

    const div = document.createElement("div");
    div.className = "bg-white p-5 rounded-lg shadow space-y-2 relative";
    div.className = "bg-white p-5 rounded-lg shadow space-y-2";

    div.innerHTML = `
  <div class="flex items-start gap-3">
    <input type="checkbox"
           class="select-item mt-1"
           data-index="${index}">

    <div class="flex-1 space-y-2">
      <h3 class="text-lg font-semibold text-indigo-600">
        <a href="${link}" target="_blank">${title}</a>
      </h3>

      <p class="text-sm text-gray-600">${authors}</p>
      <p class="text-sm text-gray-500">${publication}</p>
      <p class="text-sm text-gray-700">${snippet}</p>

      <div class="flex gap-3 text-xs mt-2">
        ${pdf ? `<span class="bg-green-100 text-green-700 px-2 py-1 rounded">PDF</span>` : ""}
        ${cited ? `<span class="bg-yellow-100 text-yellow-700 px-2 py-1 rounded">${cited}</span>` : ""}
        ${snippet ? `<span class="bg-blue-100 text-blue-700 px-2 py-1 rounded">Abstract</span>` : ""}
      </div>

      ${pdf ? `<a href="${pdf.link}" target="_blank" class="text-green-600 text-sm">üìÑ PDF</a>` : ""}
    </div>
</div>
    `;

    container.appendChild(div);
  });
}

async function searchScholar() {
  const q = document.getElementById("query").value.trim();

  if (!q) {
    alert("Vui l√≤ng nh·∫≠p t·ª´ kh√≥a h·ªçc thu·∫≠t");
    return;
  }

  showLoading();
  saveSearch(q);
  try {
    const res = await fetch(API_URL + "?q=" + encodeURIComponent(q));
    const data = await res.json();
    hideLoading();
    LAST_RESULTS = data.organic_results || [];
    renderResults(LAST_RESULTS);
  } catch (e) {
    hideLoading();
    document.getElementById("results").innerHTML =
      "<p class='text-red-500'>L·ªói khi k·∫øt n·ªëi API.</p>";
  }
}
function saveSearch(keyword) {
  let history = JSON.parse(localStorage.getItem("searchHistory")) || [];

  if (!history.includes(keyword)) {
    history.unshift(keyword);
  }

  history = history.slice(0, 5);
  localStorage.setItem("searchHistory", JSON.stringify(history));
  renderHistory();
}

function renderHistory() {
  const list = document.getElementById("searchHistory");
  if (!list) return;

  const history = JSON.parse(localStorage.getItem("searchHistory")) || [];
  list.innerHTML = "";

  history.forEach(keyword => {
    const li = document.createElement("li");
    li.innerHTML =
      "<a href='#' onclick=\"runFromHistory('" + keyword + "')\">" +
      keyword +
      "</a>";
    list.appendChild(li);
  });
}

function runFromHistory(keyword) {
  document.getElementById("query").value = keyword;
  searchScholar();
}
function getSelectedItems() {
  const checkboxes = document.querySelectorAll(".select-item:checked");
  const results = [];

  checkboxes.forEach(cb => {
    const idx = parseInt(cb.dataset.index);
    if (!isNaN(idx) && LAST_RESULTS[idx]) {
      results.push(LAST_RESULTS[idx]);
    }
  });

  return results;
}

function exportBibTeX() {
  const items = getSelectedItems();

  if (items.length === 0) {
    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b√†i ƒë·ªÉ xu·∫•t");
    return;
  }

  let bib = "";

  items.forEach((item, i) => {
    const authors =
      item.publication_info?.authors
        ? item.publication_info.authors.map(a => a.name).join(" and ")
        : "Unknown";

    const year =
      item.publication_info?.year || "????";

    bib += `@article{ref${i},
  title={${item.title || ""}},
  author={${authors}},
  year={${year}},
  url={${item.link || ""}}
}\n\n`;
  });

  downloadFile("citations.bib", bib);
}

function exportCSV() {
  const items = getSelectedItems();

  if (items.length === 0) {
    alert("Vui l√≤ng ch·ªçn √≠t nh·∫•t 1 b√†i ƒë·ªÉ xu·∫•t");
    return;
  }

  let csv = "Title,Authors,Year,Link\n";

  items.forEach(item => {
    const title = `"${(item.title || "").replace(/"/g, '""')}"`;
    const authors = `"${item.publication_info?.authors
      ?.map(a => a.name).join("; ") || ""}"`;
    const year = item.publication_info?.year || "";
    const link = item.link || "";

    csv += `${title},${authors},${year},${link}\n`;
  });

  downloadFile("citations.csv", csv);
}

function downloadFile(filename, content) {
  const blob = new Blob([content], { type: "text/plain" });
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();

  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
